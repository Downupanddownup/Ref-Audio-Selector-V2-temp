<!DOCTYPE html>
<script>
    const ReferenceAudioCompareSpace = (function () {
        
        class C_ReferenceAudioCompare {
            constructor(viewId, compareAudio) {
                this.viewId = viewId
                this.audioList = []
                this.compareAudio = compareAudio
                this.categoryList = []
            }
            
            loadData() {
                const _this = this
                $.customAjax({
                    url: BaseUrl+'audio/get_audio_category_list',
                    type: 'post',
                    success: function(res){
                        if (res.code == 0) {
                            _this.categoryList = res.data ? res.data.map(item=>new C_ObjInferenceCategory(item)) : []
                            _this.categoryList = _this.categoryList.filter(item=>item.name !== '无效')
                            _this.render()
                        } else {
                            layui.layer.msg(res.msg)
                        }
                    },
                    error: function(res, msg){
                        layui.layer.msg(msg)
                    }
                })
            }

            render() {
                const _this = this
                const getTpl = $('#referenceAudioCompareTemplate').html(); // 获取模板字符
                // 渲染并输出结果
                layui.laytpl(getTpl).render(_this, function(html){
                    const obj = $('#'+_this.viewId)
                    obj.html(html)
                    
                    obj.find('#openReportResult').on('click', function(){
                        _this.openReportResult()
                    })
                    
                    obj.find('#startCompareAudio').on('click', function(){
                        _this.startCompareAudio()
                    })
                    
                    obj.find('#clearLimitScore').on('click', function(){
                        $('#' + _this.viewId + ' #limitScore').val('')
                    })
                    
                    obj.find('#changeCategory').on('click', function(){
                        const targetCategory = $('#' + _this.viewId + ' #targetCategory').val()
                        _this.changeCategory(targetCategory)
                    })
                    
                });
                return _this
            }

            changeCategory(targetCategory){
                const _this = this
                if (_this.compareAudio == null) {
                    layui.layer.alert('请先选择音频文件')
                    return
                }
                if (!targetCategory) {
                    layui.layer.alert('请输入目标分类')
                    return
                }
                const limitScore = $('#' + _this.viewId + ' #limitScore').val()
                if (!limitScore) {
                    layui.layer.alert('请输入分割值')
                    return
                }
                $.customAjax({
                    url: BaseUrl+'audio/change_audio_category',
                    type: 'post',
                    data: {
                        audioId: _this.compareAudio.id,
                        limitScore: limitScore,
                        targetCategory:targetCategory
                    },
                    success: function(res){
                        layui.layer.msg(res.msg)
                    },
                    error: function(res, msg){
                        layui.layer.msg(msg)
                    }
                })
            }

            startCompareAudio(){
                const _this = this
                if (_this.compareAudio == null) {
                    layui.layer.alert('请先选择音频文件')
                    return
                }
                const compareCategory = $('#' + _this.viewId + ' #compareCategory').val()
                if (!compareCategory) {
                    layui.layer.alert('请先选择比对分类')
                    return
                }
                $.customAjax({
                    url: BaseUrl+'audio/start_compare_audio',
                    type: 'post',
                    data: {
                        audioId: _this.compareAudio.id,
                        categoryName:compareCategory
                    },
                    success: function(res){
                        layer.msg(res.msg)
                        if (res.code == 0) {
                           _this.openReportResult()
                        }
                    },
                    error: function(res, msg){
                        layer.msg(msg)
                    }
                })
            }

            openReportResult(){
                const _this = this

                const C_ReportResult$1 = ReportResultSpace.getReportResult('reportResultView', _this.compareAudio.id)
                
                const index = layer.open({
                    type: 1,
                    area: [SysConfig.defaultDialogWidth, SysConfig.defaultDialogHeight],
                    content: `<div id="reportResultView"></div>`,
                    btn: ['确定', '取消'],
                    yes: function(){
                        const score = C_ReportResult$1.getSelectedScore()
                        $('#' + _this.viewId + ' #limitScore').val(score)
                        layui.layer.close(index)
                    }
                });
               
                C_ReportResult$1.loadAudios()
            }
            
            
        }
        
        function getReferenceAudioCompare(viewId, compareAudio) {
            return new C_ReferenceAudioCompare(viewId, compareAudio)
        }
        
        return {
            getReferenceAudioCompare: getReferenceAudioCompare
        }
    })()
</script>

<script id="referenceAudioCompareTemplate" type="text/html">

    <table class="table1">
        <tr>
            <td class="vertical-center">

                {{# if (d.compareAudio != null) { }}

                待比较的音频：
                <audio controls>
                    <source src="{{d.compareAudio.audioPath}}" type="audio/wav">
                    <!-- 提供备用内容，比如浏览器不支持<audio>标签时显示的信息 -->
                    您的浏览器不支持 HTML5 audio 标签。
                </audio>

                {{# } }}

            </td>
            <td>
                比对目录：
                <select class="customSelect" id="compareCategory">
                    {{# layui.each(d.categoryList, function(index,item){ }}
                    <option value="{{item.name}}">{{item.name}}</option>
                    {{# }) }}
                </select>
            </td>
            <td>
                <button type="submit" class="layui-btn" id="startCompareAudio">开始比对</button>
            </td>
        </tr>
        <tr>
            <td colspan="3">
                <button type="submit" class="layui-btn" id="openReportResult">打开报告结果</button>
            </td>
        </tr>
        <tr>
            <td>
                <div style="display: flex">
                    <input type="number" autocomplete="off" id="limitScore" placeholder="请输入待分割值" class="layui-input" style="width: auto;">
                    <button type="submit" class="layui-btn" id="clearLimitScore">清空分割值</button>
                </div>
            </td>
            <td>
                <input type="text" autocomplete="on" id="targetCategory" placeholder="请输入目标分类名称" class="layui-input" style="width: auto;">
            </td>
            <td>
                <button type="submit" class="layui-btn" id="changeCategory">将分割值及以上的音频转入目标分类</button>
            </td>
        </tr>
    </table>

</script>