<!DOCTYPE html>
<script>
  const ReferenceAudioSplitSpace = (function () {
    class C_ReferenceAudioSplit {
      constructor(viewId, audio) {
        this.viewId = viewId
        this.audio = audio
        this.wavesurfer = null
        this.regions = null
        this.lastRegion = null
        this.blob = null
      }

      render() {
        const _this = this
        const getTpl = $('#referenceAudioSplitTemplate').html(); // 获取模板字符
        // 渲染并输出结果
        layui.laytpl(getTpl).render(_this, function(html){
          const obj = $('#'+_this.viewId)
          obj.html(html)
          
          _this.loadAudio()
          
          obj.find('#addRegion').on('click',function(){
            _this.addRegion()
          })
          
          obj.find('#splitAudio').on('click',function(){
            _this.splitAudio()
          })

          
        });
        return _this
      }

      splitAudio(){
        const _this = this
        extractAudioSegment(_this.blob, this.lastRegion.start, this.lastRegion.end).then(blob => {
          console.log('blob', blob)
          const audioElement = document.getElementById('testAudio'); // 使用已有的 audio 元素
          audioElement.src = URL.createObjectURL(blob); // 更新音频文件的 URL
          audioElement.play(); // 播放音频
        })
      }

      addRegion(){
        const _this = this
        _this.lastRegion = _this.regions.addRegion({
          start: 1.5,
          end: 3.5,
          content: 'Cramped region',
          color: _this.randomColor(),
          minLength: 1,
          maxLength: 10,
        })
      }
      
      async loadAudio() {
        const _this = this
        const {audioUrl, audioBlob} = await fetchAudioBlob(_this.audio.audioPath)
        _this.initWaveform(audioUrl, audioBlob)
      }

      initWaveform(audioUrl, audioBlob){
        const _this = this

        const audio = new Audio()


        audio.src = audioUrl; // 更新音频文件的 URL
        
        
        
        _this.blob = audioBlob
        
        // Create a second timeline
        const bottomTimeline = WaveSurfer.Timeline.create({
          height: 10,
          timeInterval: 0.1,
          primaryLabelInterval: 1,
          style: {
            fontSize: '10px',
            color: '#6A3274',
          },
        })
        
        const hover =  WaveSurfer.Hover.create({
                  lineColor: '#ff0000',
                  lineWidth: 2,
                  labelBackground: '#555',
                  labelColor: '#fff',
                  labelSize: '11px',
                })

        _this.regions = WaveSurfer.Regions.create()

        // Create an instance of WaveSurfer 
        _this.wavesurfer = WaveSurfer.create({
          container: '#waveform',
          waveColor: 'rgb(200, 0, 200)',
          progressColor: 'rgb(100, 0, 100)',
          media: audio,
          minPxPerSec: 100,
          // sampleRate: 32000,
          plugins: [bottomTimeline,hover,_this.regions],
        })

        console.log('wavesurfer')
        document.body.appendChild(audio)

        // Initialize the Spectrogram plugin
   /*     _this.wavesurfer.registerPlugin(
                WaveSurfer.Spectrogram.create({
                  labels: true,
                  height: 200,
                  splitChannels: true,
                })
        )*/
        
        
      }

      randomColor() {
        // Give regions a random color when they are created
        const random = (min, max) => Math.random() * (max - min) + min
        return `rgba(${random(0, 255)}, ${random(0, 255)}, ${random(0, 255)}, 0.5)`
      }

     

      

    }

    function getReferenceAudioSplit(viewId, audio) {
      return new C_ReferenceAudioSplit(viewId, audio)
    }

    return {
      getReferenceAudioSplit: getReferenceAudioSplit
    }
  })()
</script>

<script id="referenceAudioSplitTemplate" type="text/html">
  <div id="waveform">
    
  </div>
  
  <button id="addRegion">新增区域</button>
  <button id="splitAudio">提取音频</button>

  <audio controls class="custom-audio" id="testAudio">
    <source  type="audio/wav">
    <!-- 提供备用内容，比如浏览器不支持<audio>标签时显示的信息 -->
    您的浏览器不支持 HTML5 audio 标签。
  </audio>
  
</script>