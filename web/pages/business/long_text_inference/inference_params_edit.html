<!DOCTYPE html>
<script>
    const InferenceParamsEditSpace = (function () {

        class C_InferenceParams {
            constructor() {
                this.gpt_model_path = null
                this.sovits_model_path = null
                this.referWavPath = null
                this.promptText = null
                this.promptLanguage = null
                this.cutPunc = null
                this.topK = null
                this.topP = null
                this.temperature = null
                this.speed = null
            }
        }

        class C_ParamsConfig {//推理任务
            constructor(data) {
                this.gptSovitsVersion = data.gptSovitsVersion || 'v2'; // 模型版本
                this.gptModelName = data.gptModelName || ''; // GPT模型名称
                this.vitsModelName = data.vitsModelName || ''; // Vits模型名称
                this.topK = data.topK || 15; // top_k值
                this.topP = data.topP || 1.0; // top_p值
                this.temperature = data.temperature || 1.0; // 温度
                this.textDelimiter = data.textDelimiter || `,.;?!、，。？！；：…"`; // 文本分隔符
                this.speed = data.speed || 1.0; // 语速
            }
        }
        
        class C_InferenceParamsEdit {
            constructor(viewId) {
                this.viewId = viewId
                this.gptModels = []
                this.vitsModels = []
                this.C_ObjReferenceAudio$1 = null
                this.config = new C_ParamsConfig({})
                this.params = new C_InferenceParams()
            }

            loadData(){
                const _this = this

                $.customAjax({
                    url: BaseUrl+'inference/load_models',
                    type: 'post',
                    data:{
                        task_id: _this.taskId
                    },
                    success: function(res){
                        if (res.code == 0) {

                            _this.gptModels = res.data.gptModels ? res.data.gptModels.map(item=>new C_GptModel(item)) : []
                            _this.vitsModels = res.data.vitsModels ? res.data.vitsModels.map(item=>new C_VitsModel(item)) : []

                            _this.render()
                        } else {
                            layui.layer.msg(res.msg)
                        }
                    },
                    error: function(res, msg){
                        layui.layer.msg(msg)
                    }
                })

            }

            render() {
                const _this = this
                const getTpl = $('#inferenceParamsEditTemplate').html(); // 获取模板字符
                // 渲染并输出结果
                layui.laytpl(getTpl).render(_this, function(html){
                    const obj = $('#' + _this.viewId)
                    obj.html(html)
                    layui.element.render('collapse');

                    obj.find('#setInferenceParams').on('click', function() {
                        _this.setInferenceParams()
                    })
                    
                });
                return _this
            }

            setInferenceParams(){

                const _this = this
                $.customAjax({
                    url: RasApiUrl+'set_model',
                    type: 'post',
                    data:{
                        gpt_model_path:_this.params.gpt_model_path,
                        sovits_model_path:_this.params.sovits_model_path
                    },
                    success: function(res){
                        if (res === 'ok') {
                            $.customAjax({
                                url: RasApiUrl+'ras/set_default_params',
                                type: 'post',
                                data:{
                                    refer_wav_path:_this.params.referWavPath,
                                    prompt_text:_this.params.promptText,
                                    prompt_language:_this.params.promptLanguage,
                                    cut_punc:_this.params.cutPunc,
                                    top_k:_this.params.topK,
                                    top_p:_this.params.topP,
                                    temperature:_this.params.temperature,
                                    speed:_this.params.speed,
                                },
                                success: function(res){
                                    if (res === 'ok') {
                                        layui.layer.msg('参数设置成功')
                                    } else {
                                        layui.layer.msg('参数设置失败：' + res)
                                    }
                                },
                                error: function(res, msg){
                                    layui.layer.msg(msg)
                                }
                            })
                        } else {
                            layui.layer.msg('模型设置失败：' + res)
                        }
                    },
                    error: function(res, msg){
                        layui.layer.msg(msg)
                    }
                })

            }

        }

        function getInferenceParamsEdit(viewId) {
            return new C_InferenceParamsEdit(viewId)
        }

        return {
            getInferenceParamsEdit: getInferenceParamsEdit
        }
    })()
</script>

<script id="inferenceParamsEditTemplate" type="text/html">
    
    <div class="layui-collapse" lay-accordion="">
        <div class="layui-colla-item">
            <h2 class="layui-colla-title">参数设置</h2>
            <div class="layui-colla-content layui-show">

                <table class="table1">
                    <tr>
                        <td>
                            GPT-Sovits 版本：
                        </td>
                        <td>
                            <select class="customSelect" id="gsvVersion">
                                <option {{isTrue(d.config.gptSovitsVersion=="v1",'selected','')}} value="v1">v1</option>
                                <option {{isTrue(d.config.gptSovitsVersion=="v2",'selected','')}} value="v2">v2</option>
                            </select>
                            <button type="button" class="layui-btn layui-btn-sm" id="modelManager">模型管理</button>
                        </td>
                        <td>
                            GPT 模型：
                        </td>
                        <td>

                            <select class="customSelect" id="gptModel">
                                <option value="">请选择</option>
                                {{# layui.each(d.gptModels, function(index, item){ }}
                                    {{# if (d.config.gptSovitsVersion == item.version) { }}
                                        <option {{isTrue(item.name==d.config.gptModelName,'selected','')}} value="{{item.name}}">{{item.name}}</option>
                                    {{# } }}
                                {{# }) }}
                            </select>
                            <button type="button" class="layui-btn layui-btn-sm" data-refresh-model >刷新</button>

                        </td>
                        <td>
                            Vits 模型：
                        </td>
                        <td>

                            <select class="customSelect" id="vitsModel">
                                <option value="">请选择</option>
                                {{# layui.each(d.vitsModels, function(index, item){ }}
                                    {{# if (d.config.gptSovitsVersion == item.version) { }}
                                        <option {{isTrue(item.name==d.config.vitsModelName,'selected','')}} value="{{item.name}}">{{item.name}}</option>
                                    {{# } }}
                                {{# }) }}
                            </select>
                            <button type="button" class="layui-btn layui-btn-sm" data-refresh-model >刷新</button>

                        </td>
                    </tr>
                    <tr>
                        <td>
                            top_k值：
                        </td>
                        <td>

                            <input type="number" autocomplete="off" id="topK" placeholder="top_k值" class="layui-input" style="width: auto;" value="{{d.config.topK}}">

                        </td>
                        <td>
                            top_p值：
                        </td>
                        <td>

                            <input type="number" autocomplete="off" id="topP" placeholder="top_p值" class="layui-input" style="width: auto;" value="{{d.config.topP}}">

                        </td>
                        <td>
                            temperature值：
                        </td>
                        <td>

                            <input type="number" autocomplete="off" id="temperature" placeholder="temperature值" class="layui-input" style="width: auto;" value="{{d.config.temperature}}">

                        </td>
                    </tr>
                    <tr>
                        <td>
                            文本分隔符：
                        </td>
                        <td>

                            <input type="text" autocomplete="off" id="textDelimiter" placeholder="文本分隔符" class="layui-input" style="width: auto;" value="{{d.config.textDelimiter}}">

                        </td>
                        <td>
                            speed值：
                        </td>
                        <td>

                            <input type="number" autocomplete="off" id="speed" placeholder="speed值" class="layui-input" style="width: auto;" value="{{d.config.speed}}">

                        </td>
                        <td>参考音频：</td>
                        <td>

                            已选中待推理音频数量：
                            <button type="button" class="layui-btn layui-btn-sm" id="audioSelect">音频选择</button>

                        </td>
                    </tr>
                    <tr>
                        <td colspan="6">
                            <button type="button" class="layui-btn layui-btn-lg" id="setInferenceParams">设置参数</button>
                        </td>
                    </tr>
                </table>

            </div>
        </div>
    </div>
    
</script>