<!DOCTYPE html>
<script>
    const LongTextInferenceSpace = (function () {
        

        
        class C_InferenceSetting {
            constructor() {
                this.isStream = false
                this.webCutPunc = ''
                this.minTextLen = 50
                this.textLanguage = ''
                this.text = ''
            }
            splitStringByLength(str, length) {
                let result = [];
                for (let i = 0; i < str.length; i += length) {
                    // 截取从i开始，长度为length的子串
                    let chunk = str.slice(i, i + length);
                    result.push(chunk);
                }
                return result;
            }
        }
        
        class C_LongTextInference {
            constructor(viewId) {
                this.viewId = viewId
                this.streamOrNot = false// 是否为流式推理
                this.setting = new C_InferenceSetting()
                this.editObj = null
                this.dealWithObj = null
            }

            render() {
                const _this = this
                const getTpl = $('#longTextInferenceTemplate').html(); // 获取模板字符
                // 渲染并输出结果
                layui.laytpl(getTpl).render({}, function(html){
                    const obj = $('#' + _this.viewId)
                    obj.html(html)
                    
                    obj.find('#startRasApi').on('click', function() {
                        _this.startApi()
                    })
                    
                    obj.find('#stopRasApi').on('click', function() {
                        _this.stopApi()
                    })
                    
                    obj.find('#startInference').on('click', function() {
                        _this.startInference()
                    })

                    _this.editObj = InferenceParamsEditSpace.getInferenceParamsEdit('inferenceParamsEditView')
                    _this.editObj.loadData()
                    _this.dealWithObj = LongTextDealWithSpace.getLongTextDealWith('longTextDealWithView', _this.setting)
                    _this.dealWithObj.render()
                    
                });
                return _this
            }

            

            startApi(){
                const _this = this
                $.customAjax({
                    url: BaseUrl+'inference/start_ras_api',
                    type: 'post',
                    success: function(res){
                        layui.layer.msg(res.msg)
                    },
                    error: function(res, msg){
                        layui.layer.msg(msg)
                    }
                })
            }

            stopApi(){
                const _this = this
                $.customAjax({
                    url: BaseUrl+'inference/stop_ras_api',
                    type: 'post',
                    success: function(res){
                        layui.layer.msg(res.msg)
                    },
                    error: function(res, msg){
                        layui.layer.msg(msg)
                    }
                })
            }

            startInference(){
                const _this = this
                const url = RasApiUrl+'ras'
                const audioId = 'playLongTextAudio'
                if (_this.streamOrNot) {
                    
                    const subTexts = _this.setting.splitStringByLength(_this.setting.text, 50)
                    console.log(subTexts)

                    _this.playAudioSequence(url, subTexts.map(text => {
                        return {
                            text: text,
                            text_language: _this.setting.textLanguage,
                        }
                    }), audioId)
                } else {
                    fetchAndPlayAudio(url, {
                        text: _this.setting.text,
                        text_language: _this.setting.textLanguage,
                    }, audioId)
                }
            }

            // 定义一个函数来按顺序播放多个音频流
            playAudioSequence(audioUrl, requestBodys, audioId) {
                let currentIndex = 0;

                function playNextAudio() {
                    if (currentIndex >= requestBodys.length) {
                        return;
                    }

                    const requestBody = requestBodys[currentIndex];
                    startStreamAudio(audioUrl, requestBody, audioId, () => {
                        // 当前音频播放完成后，递增索引并播放下一个音频
                        currentIndex++;
                        playNextAudio();
                    });
                }

                // 从第一个音频开始播放
                playNextAudio();
            }

       }
       
       function getLongTextInference(viewId) {
           return new C_LongTextInference(viewId)
       }
       
       return {
           getLongTextInference: getLongTextInference
       }
    })()
</script>

<script id="longTextInferenceTemplate" type="text/html">
    <table class="table1">
        
        <tr>
            <td style="text-align: left">
                <div id="inferenceParamsEditView"></div>
            </td>
        </tr>
        
        
        <tr>
            <td style="text-align: left">
                <fieldset class="layui-elem-field layui-field-title">
                    <legend>长文管理</legend>
                </fieldset>
                <div id="longTextDealWithView"></div>
            </td>
        </tr>
        
        <tr>
            <td>
                <audio controls id="playLongTextAudio">
                    <source type="audio/mpeg">
                    <!-- 提供备用内容，比如浏览器不支持<audio>标签时显示的信息 -->
                    您的浏览器不支持 HTML5 audio 标签。
                </audio>
            </td>
        </tr>
        
        <tr>
            <td>
                <button type="button" class="layui-btn layui-btn-lg" id="startRasApi">启动api</button>
                <button type="button" class="layui-btn layui-btn-lg" id="startInference">开始推理</button>
                <button type="button" class="layui-btn layui-btn-lg" id="stopRasApi">关闭api</button>
            </td>
        </tr>
        
    </table>
</script>