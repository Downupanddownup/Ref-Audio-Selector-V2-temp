<!DOCTYPE html>
<script>
    const ResultAudioAllDetailSpace = (function () {
        class C_ResultAudioAllDetail {
            constructor(viewId, resultId) {
                this.viewId = viewId
                this.resultId = resultId
                this.resultAudio = null
                this.task = null
                this.refAudio = null
                this.text = null;
                this.param = null;
            }

            loadData() {
                const _this = this
                $.customAjax({
                    url: BaseUrl+'evaluation/get_inference_task_result_audio_detail',
                    type: 'post',
                    data:{
                      id: _this.resultId  
                    },
                    success: function(res){
                        if (res.code == 0) {
                            _this.resultAudio = new C_ObjInferenceTaskResultAudio(res.data)
                            _this.task = _this.resultAudio.objTask
                            _this.refAudio = _this.resultAudio.objAudio
                            _this.text = _this.resultAudio.objText
                            _this.param = _this.resultAudio.objParam
                            console.log('resultAudio', _this.resultAudio)
                            _this.task.setParams(_this.param)
                            _this.render()
                        } else {
                            layui.layer.msg(res.msg)
                        }
                    },
                    error: function(res, msg){
                        layui.layer.msg(msg)
                    }
                })
            }

            render() {
                const _this = this
                const getTpl = $('#resultAudioAllDetailTemplate').html(); // 获取模板字符
                // 渲染并输出结果
                layui.laytpl(getTpl).render(_this, function(html){
                    const obj = $('#'+_this.viewId)
                    obj.html(html)
                    
                    _this.initResultAudioWaveForm()
                    _this.initRefAudioWaveForm()
                    
                });
                return _this
            }

            initRefAudioWaveForm(){
                const _this = this

                WavesurferSpace.createWave({
                    container: '#referenceWaveForm',
                    audioId: 'referenceAudio',
                    audioSrc: _this.refAudio.audioPath,
                    type: 'all',
                })
                
            }

            initResultAudioWaveForm(){
                const _this = this
                
                WavesurferSpace.createWave({
                    container: '#resultWaveForm',
                    audioId: 'resultAudio',
                    audioSrc: _this.resultAudio.path,
                    type: 'all',
                })

            }
        }

        function getResultAudioAllDetail(viewId, resultId) {
            return new C_ResultAudioAllDetail(viewId, resultId)
        }

        return {
            getResultAudioAllDetail: getResultAudioAllDetail
        }
    })()
</script>

<script id="resultAudioAllDetailTemplate" type="text/html">

    {{# if (d.resultAudio.status == 1) { }}

        <fieldset class="layui-elem-field layui-field-title">
            <legend>结果音频</legend>
        </fieldset>
        <div style="text-align: center;margin: 10px">
            <audio controls class="custom-audio" id="resultAudio">
                <source type="audio/wav">
                <!-- 提供备用内容，比如浏览器不支持<audio>标签时显示的信息 -->
                您的浏览器不支持 HTML5 audio 标签。
            </audio>
        </div>
        <div id="resultWaveForm"></div>
    
    {{# } }}

    <fieldset class="layui-elem-field layui-field-title">
        <legend>参考音频</legend>
    </fieldset>
    <div style="text-align: center;margin: 10px">
        <audio controls class="custom-audio" id="referenceAudio">
            <source type="audio/wav">
            <!-- 提供备用内容，比如浏览器不支持<audio>标签时显示的信息 -->
            您的浏览器不支持 HTML5 audio 标签。
        </audio>
    </div>
    <div id="referenceWaveForm"></div>
    
    <table class="table1">
        <tr>
            <td>音频名称：{{d.refAudio.audioName}}</td>
            <td>音频分类：{{d.refAudio.audioCategory}}</td>
            <td>音频内容：{{d.refAudio.audioLanguage}} {{d.refAudio.audioContent}}</td>
        </tr>
        <tr>
            <td>Gpt-Sovits模型版本：{{d.task.gptSovitsVersion}}</td>
            <td>Gpt模型：{{d.task.gptModelName}}</td>
            <td>Vits模型：{{d.task.vitsModelName}}</td>
        </tr>
        <tr>
            <td>top_k：{{d.task.topK}}</td>
            <td>top_p：{{d.task.topP}}</td>
            <td>temperature：{{d.task.temperature}}</td>
        </tr>
        <tr>
            <td>文本分隔符：{{d.task.textDelimiter}}</td>
            <td>speed：{{d.task.speed}}</td>
            <td></td>
        </tr>
        <tr>
            <td>文本分类：{{d.text.category}}</td>
            <td>文本语种：{{d.text.textLanguage}}</td>
            <td>文本内容：{{d.text.textContent}}</td>
        </tr>
    </table>
    {{# if (d.resultAudio.status == 1) { }}

        <fieldset class="layui-elem-field layui-field-title">
            <legend>结果分析</legend>
        </fieldset>
        <table class="table1">
            <tr>
                <td>文本相似度：{{d.resultAudio.asrSimilarScore.toFixed(4)}}</td>
                <td>asr文本：{{d.resultAudio.asrText}}</td>
                <td>音频相似度：{{d.resultAudio.audioSimilarScore.toFixed(4)}}</td>
            </tr>
            <tr>
                <td>评分：{{d.resultAudio.score}}</td>
                <td>长文评分：{{d.resultAudio.longTextScore}}</td>
                <td>备注：{{d.resultAudio.remark}}</td>
            </tr>
        </table>
    
    {{# } }}

</script>